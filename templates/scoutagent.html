<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scout Agent - API Console</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body>
    <div class="page-container">
      <header>
        <div class="logo">
          <i class="fas fa-code"></i>
          <h1>API Agent Console</h1>
        </div>
        <nav>
          <button class="back-button" onclick="navigateTo('/')">
            <i class="fas fa-arrow-left"></i> Back to Agents
          </button>
        </nav>
      </header>

      <main class="agent-page">
        <div class="agent-header">
          <div class="agent-icon large">
            <i class="fas fa-search"></i>
          </div>
          <div class="agent-title">
            <h2>Scout Agent</h2>
            <p>Explore and retrieve information</p>
          </div>
        </div>

        <div class="agent-interface">
          <div class="input-section">
            <div class="form-group">
              <label for="scout-prompt">
                Prompt
                <span
                  class="tooltip"
                  data-tooltip="Enter instructions for the Scout Agent"
                >
                  <i class="fas fa-info-circle"></i>
                </span>
              </label>
              <textarea
                id="scout-prompt"
                rows="5"
                placeholder="Describe what you want the Scout Agent to search for..."
              ></textarea>
            </div>

            <div class="form-actions">
              <button
                id="run-button"
                class="primary-button"
                onclick="sendScoutQuery()"
              >
                <i class="fas fa-play"></i> Run Query
              </button>
              <button class="secondary-button" onclick="clearForm()">
                <i class="fas fa-eraser"></i> Clear
              </button>
            </div>
          </div>

          <div class="response-section">
            <div class="response-header">
              <h3>Json Results</h3>
              <div class="controls">
                <button
                  class="icon-button"
                  onclick="copyResponse()"
                  title="Copy to clipboard"
                >
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>

            <div id="loading" class="loading hidden">
              <div class="spinner"></div>
              <p>Scout is searching...</p>
            </div>

            <div id="scout-response" class="response-content">
              <div class="placeholder-message">
                <i class="fas fa-search"></i>
                <p>Enter a prompt and click Run Query to see results</p>
              </div>
            </div>
          </div>

          <div id="response-box" class="response-box">
            <h4>Cypher Query:</h4>
            <p id="cypher-query"></p>

            <h4>Message:</h4>
            <p id="message"></p>

            <h4>Data Status:</h4>
            <p id="isData"></p>

            <h4>Insights:</h4>
            <p id="insights"></p>

            <h4>Recommendations:</h4>
            <p id="recommendations"></p>

            <h4>Relevant Trends:</h4>
            <div id="relevant-trends"></div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const apiUrl = "http://localhost:5000";

      function navigateTo(page) {
        window.location.href = page;
      }

      function clearForm() {
        document.getElementById("scout-prompt").value = "";
      }

      function copyResponse() {
        const responseText =
          document.getElementById("scout-response").innerText;
        if (!responseText.includes("Enter a prompt")) {
          navigator.clipboard
            .writeText(responseText)
            .then(() => {
              showToast("Results copied to clipboard");
            })
            .catch((err) => {
              showToast("Failed to copy: " + err);
            });
        }
      }

      function showToast(message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 10);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 3000);
      }

      function sendScoutQuery() {
        const prompt = document.getElementById("scout-prompt").value;

        if (!prompt) {
          showToast("Please enter a prompt");
          return;
        }

        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("scout-response").innerHTML = "";

        fetch(`${apiUrl}/agent/scout/query`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ prompt }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").classList.add("hidden");

            const formattedResponse = formatJsonResponse(data);
            document.getElementById("scout-response").innerHTML =
              formattedResponse;

            displayStructuredData(data);
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("hidden");

            document.getElementById("scout-response").innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <p>Error: ${error}</p>
      </div>
    `;
          });
      }

function displayStructuredData(data) {
  const responseBox = document.getElementById("response-box");
  responseBox.style.display = "block";

  // Handle Cypher query or provide fallback message
  document.getElementById("cypher-query").textContent =
    data.cypher_query_by_llm || "No Cypher query available";

  // Handle message or provide fallback message
  document.getElementById("message").textContent =
    isValidValue(data.message) ? data.message : "No message available";

  // Check if data exists
  document.getElementById("isData").textContent = data.isData
    ? "Data found"
    : "No data found";

  // Insights section (as plain text)
  const insightsContainer = document.getElementById("insights");
  insightsContainer.textContent =
    isValidValue(data.insights) && data.insights.length > 0
      ? data.insights.join(", ")
      : "No insights available";

  // Recommendations section (as plain text)
  const recommendationsContainer = document.getElementById("recommendations");
  recommendationsContainer.textContent =
    isValidValue(data.recommendations) && data.recommendations.length > 0
      ? data.recommendations.join(", ")
      : "No recommendations available";

// Relevant trends section (as bullet points with detail)
const trendsContainer = document.getElementById("relevant-trends");
if (isValidValue(data.relevant_trends) && data.relevant_trends.length > 0) {
  trendsContainer.innerHTML =
    "<ul>" +
    data.relevant_trends
      .map(
        (trend) =>
          `<li>
        <strong>Title:</strong> ${isValidValue(trend.title) ? trend.title : "No title available"}<br>
        <strong>Summary:</strong> ${isValidValue(trend.summary_text) ? trend.summary_text : "No summary available"}<br>
        <strong>Similarity Score:</strong> ${isValidValue(trend.similarity_score) ? trend.similarity_score : "No score available"}
      </li>`
      )
      .join("") +
    "</ul>";
} else {
  trendsContainer.innerHTML =
    "<ul><li>No relevant trends available</li></ul>";
}

}

// Helper function to check for valid values (not null, NaN, or empty)
function isValidValue(value) {
  return value !== null && value !== undefined && value !== "NaN" && value !== "";
}

      function formatJsonResponse(data) {
        const jsonString = JSON.stringify(data, null, 2);
        return `<pre class="json-response">${syntaxHighlight(
          jsonString
        )}</pre>`;
      }

      function syntaxHighlight(json) {
        json = json
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            let cls = "json-number";
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = "json-key";
              } else {
                cls = "json-string";
              }
            } else if (/true|false/.test(match)) {
              cls = "json-boolean";
            } else if (/null/.test(match)) {
              cls = "json-null";
            }
            return '<span class="' + cls + '">' + match + "</span>";
          }
        );
      }
    </script>
  </body>
</html>
