<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analyst Agent - API Console</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/force-graph@1.43.4/dist/force-graph.min.js"></script>
    <style>
      /* Analyst Agent Interface Improvements */

      .visualization-controls {
        display: flex;
      }

      /* Results sections layout */
      .analyst-interface {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      .results-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .graph-visualization {
        background-color: var(--gray-50);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
      }

      .insights-section {
        background-color: var(--gray-50);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
      }

      .visualization-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .visualization-header h3 {
        font-size: 1.1rem;
        color: var(--gray-700);
        margin: 0;
      }

      /* Force Graph specific styles */
      .force-graph-container {
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        overflow: hidden;
        background-color: #fafafa;
      }

      /* Node Details Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(3px);
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        width: 80%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        color: var(--gray-500);
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
      }

      .close-modal:hover {
        color: var(--dark-color);
      }

      /* Data Cards View */
      .data-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
        background-color: var(--gray-100);
        border-radius: var(--border-radius);
        min-height: 200px;
      }

      .data-card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        border-top: 4px solid var(--primary-color);
      }

      .data-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .card-header {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .card-title {
        font-size: 1.1rem;
        margin: 0;
        color: var(--gray-800);
        line-height: 1.4;
        flex: 1;
      }

      .card-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        color: white;
        margin-left: 0.5rem;
        white-space: nowrap;
      }

      .card-body {
        padding: 1rem;
        flex: 1;
      }

      .card-summary {
        font-size: 0.9rem;
        color: var(--gray-700);
        margin-bottom: 1rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .card-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .detail-item {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
      }

      .detail-label {
        font-weight: 500;
        color: var(--gray-600);
        min-width: 100px;
      }

      .detail-value {
        color: var(--gray-800);
      }

      .card-footer {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--gray-50);
      }

      .tags-container {
        display: flex;
        gap: 0.5rem;
        overflow: hidden;
      }

      .tag {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        background-color: var(--gray-200);
        color: var(--gray-700);
        white-space: nowrap;
      }

      .tag.muted {
        color: var(--gray-500);
      }

      .card-action-btn {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
        border: none;
        border-radius: var(--border-radius);
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
      }

      .card-action-btn:hover {
        background-color: var(--primary-dark);
      }

      /* Search and filter controls */
      .graph-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        margin-top: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .search-box {
        display: flex;
        gap: 0.5rem;
      }

      .search-box input {
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        width: 250px;
      }

      .search-box button {
        padding: 0.5rem 1rem;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
      }

      .filter-options,
      .view-options {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-options select {
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
      }

      .view-btn {
        padding: 0.5rem 1rem;
        background-color: var(--gray-200);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
      }

      .view-btn.active {
        background-color: var(--primary-color);
        color: white;
      }

      /* Tabs for input methods */
      .input-tabs {
        display: flex;
        flex-direction: column;
        background-color: var(--gray-50);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
      }

      .tab-header {
        display: flex;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--gray-300);
      }

      .tab-btn {
        padding: 0.75rem 1.25rem;
        background-color: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        margin-right: 0.5rem;
        cursor: pointer;
        color: var(--gray-600);
        font-weight: 500;
        transition: var(--transition);
      }

      .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease forwards;
      }

      /* Enhanced insight sections */
      .insights-content {
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-300);
        overflow: auto;
        padding: 1.5rem;
        max-height: 500px;
      }

      .insight-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .insight-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .insight-section h4 {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .insight-section i {
        color: var(--primary-color);
      }

      .insight-content {
        background-color: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        padding: 1rem;
        font-size: 0.95rem;
        color: var(--gray-700);
        line-height: 1.6;
      }

      /* Scout Preview Section */
      .scout-preview {
        background-color: white;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius);
        min-height: 150px;
        margin-bottom: 1rem;
        padding: 1rem;
      }

      .scout-preview-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .preview-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .preview-item strong {
        color: var(--gray-700);
        font-size: 0.9rem;
      }

      .preview-item p {
        margin: 0;
        color: var(--gray-800);
      }

      /* Force Graph Improvements */
      .graph-container {
        position: relative;
        width: 100%;
        height: 500px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
      }

      .graph-container:fullscreen {
        padding: 1rem;
        background-color: #fff;
      }

      .graph-container canvas {
        border-radius: var(--border-radius);
      }

      .node-tooltip {
        position: absolute;
        background-color: rgba(33, 37, 41, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 100;
        max-width: 250px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Node visualization improvements */
      .node {
        transition: fill 0.3s ease, r 0.3s ease;
      }

      .node:hover {
        cursor: pointer;
      }

      .link {
        transition: stroke-width 0.3s ease;
      }

      /* Animation for node highlighting */
      @keyframes pulseNode {
        0% {
          r: 5;
        }
        50% {
          r: 8;
        }
        100% {
          r: 5;
        }
      }

      .pulse {
        animation: pulseNode 1s infinite;
      }

      /* Responsive grid adjustments */
      @media (max-width: 1200px) {
        .analyst-interface {
          grid-template-columns: 1fr;
        }

        .data-cards-container {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .graph-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .search-box,
        .filter-options,
        .view-options {
          width: 100%;
        }

        .view-options {
          display: grid;
          grid-template-columns: 1fr 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 5% auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <header>
        <div class="logo">
          <i class="fas fa-code"></i>
          <h1>API Agent Console</h1>
        </div>
        <nav>
          <button class="back-button" onclick="navigateTo('/')">
            <i class="fas fa-arrow-left"></i> Back to Agents
          </button>
        </nav>
      </header>

      <main class="agent-page">
        <div class="agent-header">
          <div class="agent-icon large">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="agent-title">
            <h2>Analyst Agent</h2>
            <p>Advanced trend analysis and knowledge mapping</p>
          </div>
        </div>

        <div class="analyst-interface">
          <!-- Tabs for Scout Data Entry Methods -->
          <div class="input-tabs">
            <div class="tab-header">
              <button class="tab-btn active" data-tab="paste-tab">
                Paste Scout Data
              </button>
              <button class="tab-btn" data-tab="scout-results-tab">
                Scout Results
              </button>
            </div>

            <div class="tab-content active" id="paste-tab">
              <!-- Direct Paste Input -->
              <div class="form-group">
                <label for="scout-data-input">Scout Agent Data</label>
                <textarea
                  id="scout-data-input"
                  rows="10"
                  placeholder="Paste JSON output from Scout Agent..."
                ></textarea>
              </div>

              <div class="form-actions">
                <button
                  id="analyze-button"
                  class="primary-button"
                  onclick="processAnalystQuery()"
                >
                  <i class="fas fa-chart-line"></i> Analyze Trends
                </button>
                <button class="secondary-button" onclick="clearForm()">
                  <i class="fas fa-eraser"></i> Clear
                </button>
              </div>
            </div>

            <div class="tab-content" id="scout-results-tab">
              <!-- Scout Results Selection -->
              <div class="form-group">
                <label for="scout-results-select"
                  >Select Scout Query Result</label
                >
                <select id="scout-results-select" class="scout-select">
                  <option value="">Select a previous Scout query...</option>
                </select>
              </div>

              <div id="scout-result-preview" class="scout-preview">
                <div class="placeholder-message">
                  <i class="fas fa-search"></i>
                  <p>Select a Scout result to preview</p>
                </div>
              </div>

              <div class="form-actions">
                <button
                  id="analyze-selected-button"
                  class="primary-button"
                  onclick="processSelectedScoutData()"
                  disabled
                >
                  <i class="fas fa-chart-line"></i> Analyze Selected Data
                </button>
              </div>
            </div>

            <!-- Console Log Panel -->
            <div class="console-log-panel">
              <div class="console-header">
                <h3>Process Log</h3>
                <button class="log-clear-btn" onclick="clearLogs()">
                  Clear Logs
                </button>
              </div>
              <div id="console-log" class="console-log">
                <div class="log-message system">
                  <span class="log-timestamp">System</span> Analyst Agent ready
                  to process data
                </div>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div class="results-section">
            <!-- Graph Visualization Container -->
            <div class="graph-visualization">
              <div class="visualization-header">
                <h3>Knowledge Graph</h3>
                <div class="visualization-controls">
                  <button
                    class="icon-button"
                    onclick="toggleFullscreenGraph()"
                    title="Toggle Fullscreen"
                  >
                    <i class="fas fa-expand"></i>
                  </button>
                  <button
                    class="icon-button"
                    onclick="downloadGraphImage()"
                    title="Download Graph"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <!-- increase or decrease node size -->
                  <input
                    type="range"
                    title="Node Size"
                    id="node-size"
                    min="1"
                    max="20"
                    value="8"
                    oninput="updateNodeSize(this.value)"
                  />
                </div>
              </div>
              <div id="graph-container" class="graph-container">
                <div class="placeholder-message">
                  <i class="fas fa-project-diagram"></i>
                  <p>Analyze Scout data to generate Knowledge Graph</p>
                </div>
              </div>
            </div>

            <!-- Detailed Insights Section -->
            <div class="insights-section">
              <div class="insights-header">
                <h3>Trend Analysis Insights</h3>
              </div>
              <div id="insights-container" class="insights-content">
                <div class="placeholder-message">
                  <i class="fas fa-lightbulb"></i>
                  <p>Insights will appear after analysis</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Search & Filter Controls -->
        <div class="graph-controls">
          <div class="search-box">
            <input
              type="text"
              id="node-search"
              placeholder="Search for nodes..."
            />
            <button onclick="searchNodes()">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div class="filter-options">
            <label for="domain-filter">Filter by Domain:</label>
            <select id="domain-filter" onchange="filterByDomain(this.value)">
              <option value="all">All Domains</option>
            </select>
          </div>
          <div class="view-options">
            <button
              class="view-btn active"
              data-view="graph"
              onclick="switchView('graph')"
            >
              Graph View
            </button>
            <button
              class="view-btn"
              data-view="cards"
              onclick="switchView('cards')"
            >
              Card View
            </button>
          </div>
        </div>

        <!-- Data Cards View (Alternative to Graph) -->
        <div
          id="data-cards-container"
          class="data-cards-container"
          style="display: none"
        >
          <!-- Cards will be generated here -->
        </div>

        <!-- Node Details Modal -->
        <div id="node-details-modal" class="modal">
          <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h4 id="node-details-title">Node Details</h4>
            <div id="node-details-body"></div>

            <div class="modal-actions">
              <button class="primary-button" onclick="showRelatedNodes()">
                <i class="fas fa-project-diagram"></i> Show Related
              </button>
              <button class="secondary-button close-button">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const apiUrl = "http://localhost:5000";
      let socket = null;
      let currentGraph = null;
      let graphData = null;
      let forceGraph = null;
      let selectedNodeId = null;
      let currentNodeSize = 8;

      // Store scout query results
      const scoutResults = [];

      // Socket Connection
      function connectSocket() {
        socket = io.connect(apiUrl);

        socket.on("connect", () => {
          logToConsole("Connected to server", "system");
        });

        socket.on("disconnect", () => {
          logToConsole("Disconnected from server", "warning");
        });

        socket.on("analyst_log", (data) => {
          logToConsole(
            data.message,
            data.message.includes("⚠️") ? "warning" : "info"
          );
        });

        // Listen for scout results
        socket.on("scout_result", (data) => {
          addScoutResult(data);
        });
      }

      // Add a new scout result to the selection
      function addScoutResult(data) {
        if (!data || !data.prompt) return;

        const timestamp = new Date().toLocaleTimeString();
        const resultId = "scout-" + Date.now();

        // Add to storage array
        scoutResults.push({
          id: resultId,
          timestamp: timestamp,
          prompt: data.prompt,
          data: data,
        });

        // Add to dropdown
        const select = document.getElementById("scout-results-select");
        const option = document.createElement("option");
        option.value = resultId;
        option.textContent = `${timestamp}: "${data.prompt.substring(0, 30)}${
          data.prompt.length > 30 ? "..." : ""
        }"`;
        select.appendChild(option);

        // Enable select if this is the first result
        if (scoutResults.length === 1) {
          document.getElementById("analyze-selected-button").disabled = false;
        }

        logToConsole(
          `Added Scout result for "${data.prompt.substring(0, 20)}..."`,
          "info"
        );
      }

      // Handle when user selects a scout result
      function handleScoutResultSelection() {
        const select = document.getElementById("scout-results-select");
        const resultId = select.value;

        if (!resultId) {
          document.getElementById("scout-result-preview").innerHTML = `
            <div class="placeholder-message">
              <i class="fas fa-search"></i>
              <p>Select a Scout result to preview</p>
            </div>
          `;
          document.getElementById("analyze-selected-button").disabled = true;
          return;
        }

        // Find the selected result
        const result = scoutResults.find((r) => r.id === resultId);
        if (!result) return;

        // Show preview
        const previewEl = document.getElementById("scout-result-preview");
        previewEl.innerHTML = `
          <div class="scout-preview-content">
            <div class="preview-item">
              <strong>Prompt:</strong> 
              <p>${result.data.prompt}</p>
            </div>
            <div class="preview-item">
              <strong>Trends Found:</strong> 
              <p>${result.data.relevant_trends?.length || 0} items</p>
            </div>
            <div class="preview-item">
              <strong>Timestamp:</strong> 
              <p>${result.timestamp}</p>
            </div>
          </div>
        `;

        document.getElementById("analyze-selected-button").disabled = false;
      }

      // Process the selected scout data
      function processSelectedScoutData() {
        const select = document.getElementById("scout-results-select");
        const resultId = select.value;

        if (!resultId) {
          logToConsole("No Scout result selected", "warning");
          return;
        }

        const result = scoutResults.find((r) => r.id === resultId);
        if (!result) {
          logToConsole("Selected result not found", "error");
          return;
        }

        logToConsole(
          `Processing Scout data from "${result.data.prompt.substring(
            0,
            20
          )}..."`,
          "info"
        );
        processAnalystQuery(result.data);
      }

      // Logging Function
      function logToConsole(message, type = "info") {
        const consoleLog = document.getElementById("console-log");
        const now = new Date();
        const timestamp = now.toLocaleTimeString();

        const logDiv = document.createElement("div");
        logDiv.className = `log-message ${type}`;
        logDiv.innerHTML = `<span class="log-timestamp">${timestamp}</span> ${message}`;

        consoleLog.appendChild(logDiv);
        consoleLog.scrollTop = consoleLog.scrollHeight;
      }

      // Clear Logs
      function clearLogs() {
        const consoleLog = document.getElementById("console-log");
        consoleLog.innerHTML = "";
        logToConsole("Logs cleared", "system");
      }

      // Clear Form
      function clearForm() {
        document.getElementById("scout-data-input").value = "";
        document.getElementById("graph-container").innerHTML = `
          <div class="placeholder-message">
            <i class="fas fa-project-diagram"></i>
            <p>Analyze Scout data to generate Knowledge Graph</p>
          </div>
        `;
        document.getElementById("insights-container").innerHTML = `
          <div class="placeholder-message">
            <i class="fas fa-lightbulb"></i>
            <p>Insights will appear after analysis</p>
          </div>
        `;
        document.getElementById("data-cards-container").innerHTML = "";
        logToConsole("Form cleared", "info");
      }

      // Tab switching
      function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Deactivate all tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Activate selected tab
        document.getElementById(tabId).classList.add("active");
        document
          .querySelector(`.tab-btn[data-tab="${tabId}"]`)
          .classList.add("active");
      }

      // Process Analyst Query
      function processAnalystQuery(predefinedData = null) {
        // Either use predefined data or get from textarea
        let scoutData;

        if (predefinedData) {
          scoutData = predefinedData;
        } else {
          const scoutDataInput =
            document.getElementById("scout-data-input").value;

          // Validate input
          if (!scoutDataInput.trim()) {
            logToConsole("Please enter Scout Agent data", "warning");
            return;
          }

          // Parse JSON
          try {
            scoutData = JSON.parse(scoutDataInput);
          } catch (error) {
            logToConsole("Invalid JSON input: " + error.message, "error");
            return;
          }
        }

        // Show loading state
        document.getElementById("graph-container").innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>Generating Knowledge Graph...</p>
          </div>
        `;

        // Send to Analyst Agent
        logToConsole("Sending data to Analyst Agent for processing...", "info");
        fetch(`${apiUrl}/agent/analyst/process`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(scoutData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `Server responded with status: ${response.status}`
              );
            }
            return response.json();
          })
          .then((data) => {
            logToConsole("Analysis complete", "system");
            graphData = data;

            // Populate domain filter
            populateDomainFilter(data);

            // Render Graph with Force Graph
            renderForceGraph(data);

            // Render Insights
            renderInsights(data);

            // Generate data cards
            generateDataCards(data);
          })
          .catch((error) => {
            logToConsole(`Analysis error: ${error}`, "error");
            document.getElementById("graph-container").innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error processing data: ${error.message}</p>
              </div>
            `;
          });
      }

      // Populate domain filter based on data
      function populateDomainFilter(data) {
        const filter = document.getElementById("domain-filter");
        filter.innerHTML = '<option value="all">All Domains</option>';

        // Extract unique domains
        const domains = new Set();
        if (
          data.original_scout_data &&
          data.original_scout_data.relevant_trends
        ) {
          data.original_scout_data.relevant_trends.forEach((trend) => {
            if (trend.domain) domains.add(trend.domain);
          });
        }

        // Add options
        domains.forEach((domain) => {
          const option = document.createElement("option");
          option.value = domain;
          option.textContent = domain;
          filter.appendChild(option);
        });
      }

      // Filter graph by domain
      function filterByDomain(domain) {
        if (!graphData || !forceGraph) return;

        logToConsole(`Filtering graph by domain: ${domain}`, "info");

        if (domain === "all") {
          // Reset to original graph
          renderForceGraph(graphData);
          return;
        }

        // Filter nodes and links
        const filteredData = {
          nodes: graphData.graph_data.nodes.filter(
            (node) => node.domain === domain
          ),
          links: [],
        };

        // Only keep links between remaining nodes
        const nodeIds = new Set(filteredData.nodes.map((n) => n.id));
        filteredData.links = graphData.graph_data.links.filter(
          (link) => nodeIds.has(link.source) && nodeIds.has(link.target)
        );

        // Update graph
        forceGraph.graphData(filteredData);
      }

      // Search for nodes
      function searchNodes() {
        const searchTerm = document
          .getElementById("node-search")
          .value.toLowerCase();

        if (!searchTerm || !forceGraph) return;

        logToConsole(`Searching for: ${searchTerm}`, "info");

        // Find matching nodes
        const matchingNodes = graphData.graph_data.nodes.filter(
          (node) =>
            (node.title && node.title.toLowerCase().includes(searchTerm)) ||
            (node.id && node.id.toLowerCase().includes(searchTerm))
        );

        if (matchingNodes.length === 0) {
          logToConsole(`No nodes found matching "${searchTerm}"`, "warning");
          return;
        }

        // Highlight the first matching node
        const firstMatch = matchingNodes[0];

        // Center view on the node
        forceGraph.centerAt(
          firstMatch.x,
          firstMatch.y,
          1000 // transition duration
        );

        setTimeout(() => {
          forceGraph.zoom(2.5, 1000); // zoom level, transition duration

          // Highlight the node
          selectedNodeId = firstMatch.id;
          forceGraph.refresh();

          // Show node details
          showNodeDetails(firstMatch);
        }, 1000);

        logToConsole(`Found ${matchingNodes.length} matching nodes`, "info");
      }

      // Switch between graph and card views
      function switchView(viewType) {
        // Update button states
        document.querySelectorAll(".view-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`.view-btn[data-view="${viewType}"]`)
          .classList.add("active");

        // Show/hide appropriate containers
        if (viewType === "graph") {
          document.querySelector(".graph-visualization").style.display =
            "block";
          document.getElementById("data-cards-container").style.display =
            "none";
        } else {
          document.querySelector(".graph-visualization").style.display = "none";
          document.getElementById("data-cards-container").style.display =
            "grid";
        }

        logToConsole(`Switched to ${viewType} view`, "info");
      }

      // Render Force Graph using force-graph library
      function renderForceGraph(data) {
        const graphContainer = document.getElementById("graph-container");
        graphContainer.innerHTML = ""; // Clear previous content

        if (
          !data ||
          !data.original_scout_data ||
          !data.original_scout_data.relevant_trends
        ) {
          graphContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>No trend data available for visualization</p>
            </div>
          `;
          return;
        }

        // Transform scout data into graph structure
        const trends = data.original_scout_data.relevant_trends;

        // Generate graph data
        const nodes = [];
        const links = [];
        const nodeMap = new Map();

        // Add trend nodes
        trends.forEach((trend, index) => {
          const node = {
            id: trend.id || `trend-${index}`,
            title: trend.title || "Unnamed Trend",
            type: "trend",
            domain: trend.domain || "Unknown",
            knowledge_type: trend.knowledge_type || "Unknown",
            similarity_score: trend.similarity_score || 0,
            data: trend,
          };

          nodes.push(node);
          nodeMap.set(node.id, node);

          // Add technology nodes from each trend
          if (trend.technologies && Array.isArray(trend.technologies)) {
            trend.technologies.forEach((tech) => {
              const techId = `tech-${tech.replace(/\s+/g, "-").toLowerCase()}`;

              // Only add if not already in nodes
              if (!nodeMap.has(techId)) {
                const techNode = {
                  id: techId,
                  title: tech,
                  type: "technology",
                  domain: trend.domain || "Unknown",
                };
                nodes.push(techNode);
                nodeMap.set(techId, techNode);
              }

              // Add link from trend to technology
              links.push({
                source: node.id,
                target: techId,
                type: "uses",
              });
            });
          }

          // Add keyword nodes
          if (trend.keywords && Array.isArray(trend.keywords)) {
            trend.keywords.forEach((keyword) => {
              const keywordId = `keyword-${keyword
                .replace(/\s+/g, "-")
                .toLowerCase()}`;

              if (!nodeMap.has(keywordId)) {
                const keywordNode = {
                  id: keywordId,
                  title: keyword,
                  type: "keyword",
                  domain: trend.domain || "Unknown",
                };
                nodes.push(keywordNode);
                nodeMap.set(keywordId, keywordNode);
              }

              links.push({
                source: node.id,
                target: keywordId,
                type: "has",
              });
            });
          }
        });

        // Add connections between trends based on similarity
        trends.forEach((trend1, i) => {
          trends.slice(i + 1).forEach((trend2) => {
            // Add link if they share domain or have similar scores
            if (
              trend1.domain === trend2.domain ||
              (trend1.similarity_score &&
                trend2.similarity_score &&
                Math.abs(trend1.similarity_score - trend2.similarity_score) <
                  0.2)
            ) {
              const weight = trend1.domain === trend2.domain ? 2 : 1;
              links.push({
                source: trend1.id || `trend-${i}`,
                target: trend2.id || `trend-${trends.indexOf(trend2)}`,
                type: "related",
                value: weight,
              });
            }
          });
        });

        // Save graph data for future reference
        data.graph_data = { nodes, links };

        // Create Force Graph
        forceGraph = ForceGraph()(graphContainer)
          .graphData({ nodes, links })
          .nodeId("id")
          .nodeLabel((node) => `${node.title} (${node.type})`)
          .nodeColor((node) => {
            switch (node.type) {
              case "trend":
                return "#4a6de5";
              case "technology":
                return "#28a745";
              case "keyword":
                return "#fd7e14";
              default:
                return "#6c757d";
            }
          })
          .nodeRelSize(currentNodeSize)
          .linkWidth((link) => link.value || 1)
          .linkDirectionalParticles(2)
          .linkDirectionalParticleWidth((link) => link.value || 1)
          .onNodeClick((node) => {
            selectedNodeId = node.id;
            showNodeDetails(node);
          })
          .onLinkClick((link) => {
            showLinkDetails(link);
          })
          .nodeCanvasObject((node, ctx, globalScale) => {
            // Node base rendering
            const label = node.title;
            const fontSize = 12 / globalScale;
            const nodeSize =
              node.id === selectedNodeId
                ? 14 / globalScale
                : ((node.similarity_score || 1) * 10) / globalScale;

            ctx.beginPath();
            ctx.arc(node.x, node.y, nodeSize, 0, 2 * Math.PI, false);
            ctx.fillStyle =
              node.id === selectedNodeId
                ? "#ff5252" // Highlighted node
                : node.color ||
                  (node.type === "trend"
                    ? "#4a6de5"
                    : node.type === "technology"
                    ? "#28a745"
                    : "#fd7e14");
            ctx.fill();

            // Add text only if zoomed in enough for readability
            if (globalScale > 0.4) {
              ctx.font = `${fontSize}px Sans-Serif`;
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillStyle = "white";
              ctx.fillText(label, node.x, node.y);
            }
          });

        logToConsole(
          `Rendered knowledge graph with ${nodes.length} nodes and ${links.length} links`,
          "info"
        );
      }

      // Update node size
      function updateNodeSize(size) {
        currentNodeSize = size;
        if (forceGraph) {
          forceGraph.nodeRelSize(currentNodeSize);
        }
      }

      // Show node details
      function showNodeDetails(node) {
        const modal = document.getElementById("node-details-modal");
        document.getElementById("node-details-title").textContent =
          node.title || "Node Details";

        let detailsHtml = `
          <div class="node-details">
            <p><strong>Type:</strong> ${node.type || "Unknown"}</p>
            <p><strong>Domain:</strong> ${node.domain || "Not specified"}</p>
        `;

        // Add additional details based on node type
        if (node.type === "trend") {
          const trend = node.data || {};
          detailsHtml += `
            <p><strong>Knowledge Type:</strong> ${
              trend.knowledge_type || "Not specified"
            }</p>
            <p><strong>Publication Date:</strong> ${
              trend.publication_date || "Not specified"
            }</p>
            <p><strong>Similarity Score:</strong> ${(
              trend.similarity_score || 0
            ).toFixed(4)}</p>
            <p><strong>Data Quality Score:</strong> ${(
              trend.data_quality_score || 0
            ).toFixed(2)}</p>
            
            <div class="details-section">
              <h5>Summary</h5>
              <p>${trend.summary_text || "No summary available"}</p>
            </div>
          `;

          // Add technologies if available
          if (trend.technologies && trend.technologies.length > 0) {
            detailsHtml += `
              <div class="details-section">
                <h5>Technologies</h5>
                <ul>
                  ${trend.technologies
                    .map((tech) => `<li>${tech}</li>`)
                    .join("")}
                </ul>
              </div>
            `;
          }

          // Add keywords if available
          if (trend.keywords && trend.keywords.length > 0) {
            detailsHtml += `
              <div class="details-section">
                <h5>Keywords</h5>
                <ul>
                  ${trend.keywords
                    .map((keyword) => `<li>${keyword}</li>`)
                    .join("")}
                </ul>
              </div>
            `;
          }
        }

        detailsHtml += `</div>`;
        document.getElementById("node-details-body").innerHTML = detailsHtml;

        // Show the modal
        modal.style.display = "block";

        // Setup close button event
        document.querySelector(".close-modal").onclick = function () {
          modal.style.display = "none";
          selectedNodeId = null;
          forceGraph.refresh();
        };
        document.querySelector(".close-button").onclick = function () {
          modal.style.display = "none";
          selectedNodeId = null;
          forceGraph.refresh();
        };

        // Close when clicking outside
        window.onclick = function (event) {
          if (event.target === modal) {
            modal.style.display = "none";
            selectedNodeId = null;
            forceGraph.refresh();
          }
        };
      }

      // Show link details
      function showLinkDetails(link) {
        logToConsole(
          `Link selected: ${link.source.title || link.source} → ${
            link.target.title || link.target
          }`,
          "info"
        );

        // Highlight connected nodes
        selectedNodeId = null; // Clear any selected node

        if (typeof link.source === "object") {
          // Highlight source and target nodes
          forceGraph
            .nodeColor((node) => {
              if (node.id === link.source.id || node.id === link.target.id) {
                return "#ff5252"; // Highlight color
              }

              switch (node.type) {
                case "trend":
                  return "#4a6de5";
                case "technology":
                  return "#28a745";
                case "keyword":
                  return "#fd7e14";
                default:
                  return "#6c757d";
              }
            })
            .refresh();
        }
      }

      // Show related nodes
      function showRelatedNodes() {
        if (!selectedNodeId || !forceGraph) return;

        const graphData = forceGraph.graphData();

        // Find links connected to the selected node
        const connectedLinks = graphData.links.filter(
          (link) =>
            (typeof link.source === "object" ? link.source.id : link.source) ===
              selectedNodeId ||
            (typeof link.target === "object" ? link.target.id : link.target) ===
              selectedNodeId
        );

        // Get connected node IDs
        const connectedNodeIds = new Set();
        connectedLinks.forEach((link) => {
          const sourceId =
            typeof link.source === "object" ? link.source.id : link.source;
          const targetId =
            typeof link.target === "object" ? link.target.id : link.target;

          if (sourceId !== selectedNodeId) connectedNodeIds.add(sourceId);
          if (targetId !== selectedNodeId) connectedNodeIds.add(targetId);
        });

        logToConsole(`Found ${connectedNodeIds.size} related nodes`, "info");

        // Highlight the connected nodes
        forceGraph
          .nodeColor((node) => {
            if (node.id === selectedNodeId) {
              return "#ff5252"; // Selected node
            } else if (connectedNodeIds.has(node.id)) {
              return "#ffab00"; // Connected nodes
            }

            // Default colors
            switch (node.type) {
              case "trend":
                return "#4a6de5";
              case "technology":
                return "#28a745";
              case "keyword":
                return "#fd7e14";
              default:
                return "#6c757d";
            }
          })
          .linkWidth((link) => {
            const sourceId =
              typeof link.source === "object" ? link.source.id : link.source;
            const targetId =
              typeof link.target === "object" ? link.target.id : link.target;

            if (sourceId === selectedNodeId || targetId === selectedNodeId) {
              return 4; // Highlight connected links
            }
            return link.value || 1;
          })
          .linkDirectionalParticles((link) => {
            const sourceId =
              typeof link.source === "object" ? link.source.id : link.source;
            const targetId =
              typeof link.target === "object" ? link.target.id : link.target;

            if (sourceId === selectedNodeId || targetId === selectedNodeId) {
              return 4;
            }
            return 0;
          })
          .refresh();

        // Close the modal
        document.getElementById("node-details-modal").style.display = "none";
      }

      // Toggle fullscreen for graph
      function toggleFullscreenGraph() {
        const container = document.querySelector(".graph-visualization");

        if (!document.fullscreenElement) {
          if (container.requestFullscreen) {
            container.requestFullscreen();
          } else if (container.mozRequestFullScreen) {
            container.mozRequestFullScreen();
          } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
          } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
          }
          logToConsole("Entered fullscreen mode", "info");
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          logToConsole("Exited fullscreen mode", "info");
        }
      }

      // Download graph as image
      function downloadGraphImage() {
        if (!forceGraph) {
          logToConsole("No graph to download", "warning");
          return;
        }

        try {
          // Get canvas from force graph
          const canvas = document.querySelector(".graph-visualization canvas");
          if (!canvas) {
            logToConsole("Graph canvas not found", "error");
            return;
          }

          // Create a download link
          const link = document.createElement("a");
          link.download = "knowledge-graph.png";
          link.href = canvas
            .toDataURL("image/png")
            .replace("image/png", "image/octet-stream");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          logToConsole("Graph image downloaded", "info");
        } catch (error) {
          logToConsole(`Error downloading image: ${error.message}`, "error");
        }
      }

      // Generate data cards for card view
      function generateDataCards(data) {
        const cardsContainer = document.getElementById("data-cards-container");
        cardsContainer.innerHTML = "";

        if (
          !data ||
          !data.original_scout_data ||
          !data.original_scout_data.relevant_trends
        ) {
          cardsContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>No trend data available</p>
            </div>
          `;
          return;
        }

        const trends = data.original_scout_data.relevant_trends;

        trends.forEach((trend) => {
          // Create card element
          const card = document.createElement("div");
          card.className = "data-card";

          // Calculate color based on domain
          let domainColor = "#4a6de5"; // Default blue
          if (trend.domain) {
            switch (trend.domain.toLowerCase()) {
              case "healthcare":
                domainColor = "#28a745";
                break; // Green
              case "mobility":
                domainColor = "#fd7e14";
                break; // Orange
              case "technology":
                domainColor = "#17a2b8";
                break; // Teal
            }
          }

          card.innerHTML = `
            <div class="card-header" style="border-color: ${domainColor}">
              <h3 class="card-title">${trend.title || "Unnamed Trend"}</h3>
              <span class="card-badge" style="background-color: ${domainColor}">${
            trend.domain || "Unknown"
          }</span>
            </div>
            <div class="card-body">
              <p class="card-summary">${
                trend.summary_text || "No summary available"
              }</p>
              <div class="card-details">
                <div class="detail-item">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value">${
                    trend.knowledge_type || "Unknown"
                  }</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Publication:</span>
                  <span class="detail-value">${
                    trend.publication_date || "Unknown"
                  }</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Similarity:</span>
                  <span class="detail-value">${(
                    trend.similarity_score || 0
                  ).toFixed(4)}</span>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <div class="tags-container">
                ${
                  Array.isArray(trend.keywords) && trend.keywords.length > 0
                    ? trend.keywords
                        .slice(0, 3)
                        .map((kw) => `<span class="tag">${kw}</span>`)
                        .join("")
                    : '<span class="tag muted">No keywords</span>'
                }
              </div>
              <button class="card-action-btn" onclick="showCardDetails('${
                trend.id
              }')">
                <i class="fas fa-info-circle"></i> Details
              </button>
            </div>
          `;

          cardsContainer.appendChild(card);
        });

        logToConsole(`Generated ${trends.length} data cards`, "info");
      }

      // Show details for a specific card
      function showCardDetails(trendId) {
        if (!graphData || !graphData.original_scout_data) return;

        const trend = graphData.original_scout_data.relevant_trends.find(
          (t) => t.id === trendId
        );
        if (!trend) {
          logToConsole(`Trend with ID ${trendId} not found`, "error");
          return;
        }

        // Create a node-like object to pass to showNodeDetails
        const nodeObj = {
          id: trend.id,
          title: trend.title,
          type: "trend",
          domain: trend.domain,
          data: trend,
        };

        // Show details modal
        showNodeDetails(nodeObj);
      }

      // Render Insights
      function renderInsights(data) {
        const insightsContainer = document.getElementById("insights-container");
        insightsContainer.innerHTML = ""; // Clear previous content

        // Check for error
        if (data.error) {
          insightsContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>${data.error}</p>
            </div>
          `;
          return;
        }

        const insights = data.graph_insights || {};

        // Create insights section
        const insightsDiv = document.createElement("div");
        insightsDiv.classList.add("insights-details");

        // Render different types of insights
        const sections = [
          {
            key: "central_technologies",
            title: "Central Technologies",
            icon: "fa-microchip",
          },
          {
            key: "cross_domain_connections",
            title: "Cross-Domain Connections",
            icon: "fa-link",
          },
          {
            key: "innovation_pathways",
            title: "Innovation Pathways",
            icon: "fa-road",
          },
        ];

        sections.forEach((section) => {
          if (insights[section.key]) {
            const sectionDiv = document.createElement("div");
            sectionDiv.classList.add("insight-section");

            const titleEl = document.createElement("h4");
            titleEl.innerHTML = `<i class="fas ${section.icon}"></i> ${section.title}`;
            sectionDiv.appendChild(titleEl);

            const contentEl = document.createElement("div");
            contentEl.classList.add("insight-content");
            contentEl.innerHTML = insights[section.key].replace(/\n/g, "<br>");
            sectionDiv.appendChild(contentEl);

            insightsDiv.appendChild(sectionDiv);
          }
        });

        insightsContainer.appendChild(insightsDiv);
      }

      // Navigation
      function navigateTo(page) {
        window.location.href = page;
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        connectSocket();

        // Setup tab switching
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            switchTab(btn.dataset.tab);
          });
        });

        // Setup scout result selection
        document
          .getElementById("scout-results-select")
          .addEventListener("change", handleScoutResultSelection);

        // Check for stored scout results in localStorage
        try {
          const storedResults = localStorage.getItem("scoutResults");
          if (storedResults) {
            JSON.parse(storedResults).forEach((result) => {
              if (result && result.data && result.data.prompt) {
                addScoutResult(result.data);
              }
            });
          }
        } catch (e) {
          console.error("Error loading stored scout results:", e);
        }
      });
    </script>
  </body>
</html>
